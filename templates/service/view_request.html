{% extends "base.html" %}

{% block title %}Service Request #{{ service_request.id }} - Vehicle Service Management{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Service Request #{{ service_request.id }}</h4>
        <span class="badge bg-{{ 'success' if service_request.status == 'completed' else 'warning' if service_request.status == 'pending' else 'info' }} fs-6">
            {{ service_request.status|replace('_', ' ')|title }}
        </span>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table">
                    <tr>
                        <th>Vehicle:</th>
                        <td>{{ service_request.vehicle.registration_number }} - {{ service_request.vehicle.brand }} {{ service_request.vehicle.model }}</td>
                    </tr>
                    <tr>
                        <th>Service Type:</th>
                        <td>{{ service_request.service_type }}</td>
                    </tr>
                    {% if service_request.custom_service_description %}
                    <tr>
                        <th>Service Description:</th>
                        <td>{{ service_request.custom_service_description }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Preferred Date:</th>
                        <td>{{ service_request.preferred_date.strftime('%Y-%m-%d') }}</td>
                    </tr>
                    {% if service_request.preferred_time %}
                    <tr>
                        <th>Preferred Time:</th>
                        <td>{{ service_request.preferred_time.strftime('%H:%M') }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Requested On:</th>
                        <td>{{ service_request.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    </tr>
                    {% if service_request.admin_notes %}
                    <tr>
                        <th>Admin Notes:</th>
                        <td>{{ service_request.admin_notes }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
        {% if current_user.is_admin() %}
        <div class="mt-3">
            {% if service_request.status != 'completed' %}
            <a href="{{ url_for('service.update_status', request_id=service_request.id) }}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Update Status
            </a>
            {% endif %}
            {% if service_request.status != 'completed' and not service_request.service_record %}
            <a href="{{ url_for('service.complete_service', request_id=service_request.id) }}" class="btn btn-success">
                <i class="bi bi-check-circle"></i> Complete Service
            </a>
            {% endif %}
            {% if service_request.status == 'completed' and service_request.service_record and service_request.service_record.invoice %}
            {% if service_request.service_record.invoice.payment_status != 'paid' %}
            <form method="POST" action="{{ url_for('service.mark_request_paid', request_id=service_request.id) }}" style="display: inline;">
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-cash"></i> Cash Paid
                </button>
            </form>
            {% endif %}
            {% endif %}
        </div>
        {% endif %}
        {% if service_request.service_record and service_request.service_record.invoice %}
        <div class="mt-3">
            <a href="{{ url_for('service.view_invoice', invoice_id=service_request.service_record.invoice.id) }}" class="btn btn-info">
                <i class="bi bi-receipt"></i> View Invoice
            </a>
            {% if service_request.service_record.invoice.payment_status != 'paid' and not current_user.is_admin() %}
            <a href="{{ url_for('service.pay_invoice', invoice_id=service_request.service_record.invoice.id) }}" class="btn btn-success">
                <i class="bi bi-credit-card"></i> Pay Invoice
            </a>
            {% elif service_request.service_record.invoice.payment_status == 'paid' %}
            <span class="badge bg-success ms-2">âœ“ Paid on {{ service_request.service_record.invoice.payment_date.strftime('%d %b %Y') }}</span>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

